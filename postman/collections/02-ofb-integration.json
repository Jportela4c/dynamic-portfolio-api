{
  "info": {
    "_postman_id": "ofb-integration-v1",
    "name": "02 - OFB Integration & JWS",
    "description": "OFB mock server integration testing including OAuth2 PAR flow, JWS signature verification, and mTLS validation",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "01 - Complete Risk Profile Flow (E2E)",
      "item": [
        {
          "name": "E2E - Get Risk Profile (Triggers OFB)",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Get fresh API token",
                  "pm.sendRequest({",
                  "    url: pm.environment.get('baseUrl') + '/oauth2/token',",
                  "    method: 'POST',",
                  "    header: {",
                  "        'Content-Type': 'application/x-www-form-urlencoded',",
                  "        'Authorization': 'Basic ' + btoa('portfolio-api-client:api-secret')",
                  "    },",
                  "    body: {",
                  "        mode: 'urlencoded',",
                  "        urlencoded: [",
                  "            { key: 'grant_type', value: 'client_credentials' },",
                  "            { key: 'scope', value: 'read write' }",
                  "        ]",
                  "    }",
                  "}, (err, res) => {",
                  "    if (!err && res.code === 200) {",
                  "        const json = res.json();",
                  "        pm.environment.set('jwtToken', json.access_token);",
                  "        console.log('API token obtained');",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", () => {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Response has risk profile data\", () => {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('clienteId');",
                  "    pm.expect(json).to.have.property('perfil');",
                  "    pm.expect(json).to.have.property('pontuacao');",
                  "    pm.expect(json).to.have.property('descricao');",
                  "});",
                  "",
                  "pm.test(\"Profile is valid\", () => {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.perfil).to.be.oneOf(['Conservador', 'Moderado', 'Agressivo']);",
                  "});",
                  "",
                  "pm.test(\"Score is within range\", () => {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.pontuacao).to.be.at.least(0);",
                  "    pm.expect(json.pontuacao).to.be.at.most(100);",
                  "});",
                  "",
                  "// This request should have triggered OFB OAuth2 PAR flow + JWS verification",
                  "console.log('E2E Flow Complete: API OAuth2 → /perfil-risco → OFB PAR → OFB Token → JWS-signed investments → Risk calculation');"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{jwtToken}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/perfil-risco/1",
              "host": ["{{baseUrl}}"],
              "path": ["perfil-risco", "1"]
            }
          },
          "response": []
        },
        {
          "name": "E2E - Non-Existing Customer (No OFB Call)",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Ensure token is available",
                  "if (!pm.environment.get('jwtToken')) {",
                  "    pm.sendRequest({",
                  "        url: pm.environment.get('baseUrl') + '/oauth2/token',",
                  "        method: 'POST',",
                  "        header: {",
                  "            'Content-Type': 'application/x-www-form-urlencoded',",
                  "            'Authorization': 'Basic ' + btoa('portfolio-api-client:api-secret')",
                  "        },",
                  "        body: {",
                  "            mode: 'urlencoded',",
                  "            urlencoded: [",
                  "                { key: 'grant_type', value: 'client_credentials' },",
                  "                { key: 'scope', value: 'read write' }",
                  "            ]",
                  "        }",
                  "    }, (err, res) => {",
                  "        if (!err && res.code === 200) {",
                  "            pm.environment.set('jwtToken', res.json().access_token);",
                  "        }",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 404\", () => {",
                  "    pm.response.to.have.status(404);",
                  "});",
                  "",
                  "pm.test(\"Response has error message\", () => {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('message');",
                  "    pm.expect(json).to.have.property('status', 404);",
                  "});",
                  "",
                  "console.log('Customer 999 not found - OFB call should NOT have been made');"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{jwtToken}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/perfil-risco/999",
              "host": ["{{baseUrl}}"],
              "path": ["perfil-risco", "999"]
            }
          },
          "response": []
        }
      ]
    },
    {
      "name": "02 - JWS Verification Tests",
      "item": [
        {
          "name": "Verify JWS Response Format",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Note: This test validates that OFB returns JWS-signed responses",
                  "// The actual JWS verification happens in the API backend",
                  "console.log('Testing JWS signature verification through risk profile endpoint');"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Risk profile calculated successfully\", () => {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 404]);",
                  "});",
                  "",
                  "if (pm.response.code === 200) {",
                  "    pm.test(\"Response contains investment data from OFB\", () => {",
                  "        const json = pm.response.json();",
                  "        // If OFB call succeeded, we got JWS-signed data",
                  "        pm.expect(json).to.have.property('perfil');",
                  "        pm.expect(json).to.have.property('pontuacao');",
                  "        console.log('JWS verification passed - profile calculated from OFB data');",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{jwtToken}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/perfil-risco/1",
              "host": ["{{baseUrl}}"],
              "path": ["perfil-risco", "1"]
            }
          },
          "response": []
        }
      ]
    },
    {
      "name": "03 - OAuth2 PAR Flow Validation",
      "item": [
        {
          "name": "Trigger OFB PAR Flow",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Request completed\", () => {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 404, 500]);",
                  "});",
                  "",
                  "if (pm.response.code === 200) {",
                  "    console.log('OFB PAR flow triggered successfully:');",
                  "    console.log('1. API → OFB PAR endpoint (POST /oauth2/par)');",
                  "    console.log('2. OFB returns request_uri');",
                  "    console.log('3. API → OFB token endpoint with request_uri');",
                  "    console.log('4. OFB returns access token');",
                  "    console.log('5. API → OFB investments endpoint with token');",
                  "    console.log('6. OFB returns JWS-signed investment data');",
                  "    console.log('7. API verifies JWS signature using JWKS');",
                  "    console.log('8. API calculates risk profile');",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{jwtToken}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/perfil-risco/1",
              "host": ["{{baseUrl}}"],
              "path": ["perfil-risco", "1"]
            }
          },
          "response": []
        }
      ]
    },
    {
      "name": "04 - mTLS Validation",
      "item": [
        {
          "name": "Verify mTLS Connection (Implicit)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"API successfully connected to OFB via mTLS\", () => {",
                  "    // If we get a 200, mTLS handshake succeeded",
                  "    // If we get 404, customer not found (but mTLS worked)",
                  "    // If we get 500, could be mTLS failure",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 404]);",
                  "});",
                  "",
                  "if (pm.response.code === 200) {",
                  "    console.log('mTLS validation passed:');",
                  "    console.log('✓ API client certificate validated by OFB');",
                  "    console.log('✓ OFB server certificate validated by API');",
                  "    console.log('✓ Certificate chain verified (CA: portfolio-ca.local)');",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{jwtToken}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/perfil-risco/1",
              "host": ["{{baseUrl}}"],
              "path": ["perfil-risco", "1"]
            }
          },
          "response": []
        }
      ]
    },
    {
      "name": "05 - Error Handling",
      "item": [
        {
          "name": "OFB Unavailable Scenario",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "console.log('Note: This test would require stopping the OFB container');",
                  "console.log('In production, API should gracefully handle OFB unavailability');"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// With OFB running, should get 200 or 404",
                  "// With OFB stopped, should get 503 or 500",
                  "pm.test(\"Request completes\", () => {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 404, 500, 503]);",
                  "});",
                  "",
                  "if (pm.response.code === 503 || pm.response.code === 500) {",
                  "    console.log('OFB service unavailable - graceful error handling');",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{jwtToken}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/perfil-risco/1",
              "host": ["{{baseUrl}}"],
              "path": ["perfil-risco", "1"]
            }
          },
          "response": []
        },
        {
          "name": "Invalid Token - No OFB Call",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 401\", () => {",
                  "    pm.response.to.have.status(401);",
                  "});",
                  "",
                  "console.log('Authentication failed - OFB call should NOT have been made');"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "invalid.token.here",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/perfil-risco/1",
              "host": ["{{baseUrl}}"],
              "path": ["perfil-risco", "1"]
            }
          },
          "response": []
        }
      ]
    },
    {
      "name": "06 - Performance Validation",
      "item": [
        {
          "name": "Risk Profile Response Time (with OFB)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Response time acceptable (< 3000ms with OFB call)\", () => {",
                  "    pm.expect(pm.response.responseTime).to.be.below(3000);",
                  "});",
                  "",
                  "pm.test(\"Response time good (< 2000ms)\", () => {",
                  "    pm.expect(pm.response.responseTime).to.be.below(2000);",
                  "});",
                  "",
                  "console.log('Response time: ' + pm.response.responseTime + 'ms (includes full OFB PAR + JWS flow)');"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{jwtToken}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/perfil-risco/2",
              "host": ["{{baseUrl}}"],
              "path": ["perfil-risco", "2"]
            }
          },
          "response": []
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "console.log('Running OFB Integration test: ' + pm.info.requestName);"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "pm.test(\"Response has correct content type (if not auth error)\", () => {",
          "    if (pm.response.code !== 401 && pm.response.code !== 403) {",
          "        pm.expect(pm.response.headers.get('Content-Type')).to.include('application/json');",
          "    }",
          "});"
        ]
      }
    }
  ]
}
