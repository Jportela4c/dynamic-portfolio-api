version: '3'

set:
  - pipefail

vars:
  PROJECT_NAME: dynamic-portfolio-api
  DOCKER_MIN_VERSION: "20.10"
  DOCKER_COMPOSE_MIN_VERSION: "2.0"
  SERVER_PORT: '{{.SERVER_PORT | default "8080"}}'
  MVNW: '{{if eq OS "windows"}}./mvnw.cmd{{else}}./mvnw{{end}}'

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  run:
    desc: Run the entire application (installs Task if needed, then runs setup)
    deps:
      - setup

  setup:
    desc: Complete project setup (checks dependencies, installs tools, starts services)
    silent: true
    cmds:
      - task: check-dependencies
      - task: install-tools
      - task: docker-up
      - |
        echo "âœ… Setup complete! API is available at http://localhost:{{.SERVER_PORT}}/api/v1"
        echo "ğŸ“– Access API docs at http://localhost:{{.SERVER_PORT}}/api/v1/swagger-ui.html"

  check-dependencies:
    desc: Check if required dependencies are installed
    silent: true
    cmds:
      - task: check-docker
      - task: check-docker-compose
      - echo "âœ… All dependencies satisfied"

  check-docker:
    desc: Verify Docker is installed and version is sufficient
    silent: true
    cmds:
      - |
        if ! command -v docker >/dev/null 2>&1; then
          echo "âŒ Docker is not installed"
          echo "ğŸ“¥ Install from: https://docs.docker.com/get-docker/"
          exit 1
        fi
        echo "âœ… Docker found: $(docker --version)"

  check-docker-compose:
    desc: Verify Docker Compose is installed
    silent: true
    cmds:
      - |
        if ! docker compose version >/dev/null 2>&1; then
          echo "âŒ Docker Compose is not available"
          echo "ğŸ“¥ Install Docker Desktop or Docker Compose plugin"
          exit 1
        fi
        echo "âœ… Docker Compose found: $(docker compose version)"

  install-tools:
    desc: Install optional development tools (Java, Maven) via SDKMAN
    silent: true
    cmds:
      - |
        # Source SDKMAN if it exists (use bash for compatibility)
        if [ -f "$HOME/.sdkman/bin/sdkman-init.sh" ]; then
          bash -c 'source "$HOME/.sdkman/bin/sdkman-init.sh" && sdk env install' || echo "âš ï¸  Tools may already be installed"
        elif command -v sdk >/dev/null 2>&1; then
          echo "ğŸ“¦ SDKMAN detected, installing Java and Maven..."
          sdk env install || echo "âš ï¸  Tools may already be installed"
        else
          echo "âš ï¸  SDKMAN not found - skipping local development tools"
          echo "ğŸ’¡ For local development, install SDKMAN: https://sdkman.io/"
          echo "ğŸ’¡ Or ensure Java 21 and Maven 3.9+ are installed manually"
        fi

  docker-up:
    desc: Start all Docker containers (builds locally if Maven available, otherwise Docker builds)
    silent: true
    env:
      SERVER_PORT: '{{.SERVER_PORT}}'
    cmds:
      - |
        BUILD_SUCCESS=false

        # Generate SSL certificates for OFB mock server
        echo "ğŸ” Generating SSL certificates..."
        cd ofb-mock-server && bash generate-certs.sh && cd .. || echo "âš ï¸  Certificate generation failed, will try without certs"

        if [ -x ./mvnw ] || [ -x ./mvnw.cmd ]; then
          echo "ğŸ”¨ Building main API JAR..."
          if {{.MVNW}} clean package -Dmaven.test.skip=true; then
            echo "ğŸ”¨ Building OFB mock server JAR..."
            if cd ofb-mock-server && {{.MVNW}} clean package -Dmaven.test.skip=true -Dorg.slf4j.simpleLogger.defaultLogLevel=error -Dorg.slf4j.simpleLogger.log.org.openapitools=off && cd ..; then
              echo "ğŸ³ Building Docker images (using pre-built JARs)..."
              if docker build -t dynamic-portfolio-api-api:latest -f Dockerfile.local . && docker build -t dynamic-portfolio-api-ofb-mock-server:latest -f ofb-mock-server/Dockerfile.local ofb-mock-server; then
                BUILD_SUCCESS=true
              fi
            fi
          fi

          if [ "$BUILD_SUCCESS" = false ]; then
            echo "âš ï¸  Local build failed - falling back to Docker multi-stage build"
            echo "ğŸ³ Building application (compiles inside Docker)..."
            docker compose build --pull || (echo "âŒ Docker build also failed!" && exit 1)
          fi
        else
          echo "ğŸ³ Building application (multi-stage, compiles inside Docker)..."
          docker compose build --pull || (echo "âŒ Build failed! Check Docker is running." && exit 1)
        fi
      - echo "ğŸš€ Starting Docker containers..."
      - docker compose up -d --wait --force-recreate || (echo "âŒ Container startup failed! Showing logs:" && docker compose logs --tail=50 && exit 1)
      - echo "âœ… All services are running"

  docker-down:
    desc: Stop all Docker containers
    silent: true
    cmds:
      - echo "ğŸ›‘ Stopping Docker containers..."
      - docker compose down

  docker-clean:
    desc: Stop containers and remove volumes (clean slate)
    silent: true
    cmds:
      - echo "ğŸ§¹ Cleaning up containers and volumes..."
      - docker compose down -v
      - echo "âœ… Clean up complete"

  logs:
    desc: Show logs from all containers
    cmds:
      - docker compose logs -f

  logs-api:
    desc: Show API container logs
    cmds:
      - docker compose logs -f api

  logs-db:
    desc: Show database container logs
    cmds:
      - docker compose logs -f sqlserver

  logs-flyway:
    desc: Show Flyway migration logs
    cmds:
      - docker compose logs flyway

  status:
    desc: Show status of all containers
    cmds:
      - docker compose ps

  test:
    desc: Run all tests (requires Java and Maven)
    cmds:
      - |
        if command -v mvn >/dev/null 2>&1; then
          mvn test
        else
          echo "âŒ Maven not found. Install via SDKMAN or manually."
          exit 1
        fi

  build:
    desc: Build the application (requires Java and Maven)
    cmds:
      - |
        if command -v mvn >/dev/null 2>&1; then
          mvn clean package
        else
          echo "âŒ Maven not found. Install via SDKMAN or manually."
          exit 1
        fi

  build-local:
    desc: Build JAR locally with Maven Wrapper (fast on Mac)
    cmds:
      - '{{.MVNW}} clean package -Dmaven.test.skip=true'

  rebuild-api:
    desc: Build JAR locally and rebuild Docker API container (optimized for Mac)
    silent: true
    env:
      SERVER_PORT: '{{.SERVER_PORT}}'
    cmds:
      - echo "ğŸ”¨ Building JAR locally..."
      - '{{.MVNW}} clean package -Dmaven.test.skip=true'
      - echo "ğŸ³ Rebuilding Docker image (fast local build)..."
      - docker build --no-cache -t dynamic-portfolio-api-api:latest -f Dockerfile.local .
      - echo "ğŸš€ Starting API container..."
      - docker compose up -d api
      - sleep 2
      - echo "âœ… API rebuilt and started on port {{.SERVER_PORT}} - showing logs (Ctrl+C to exit):"
      - docker logs portfolio-api --tail 100 -f

  rebuild-all:
    desc: Rebuild both APIs (main + OFB mock) and restart all Docker services (fast local build)
    silent: true
    env:
      SERVER_PORT: '{{.SERVER_PORT}}'
    cmds:
      - echo "ğŸ›‘ Stopping all containers..."
      - docker compose down
      - |
        BUILD_SUCCESS=false

        # Generate SSL certificates for OFB mock server
        echo "ğŸ” Generating SSL certificates..."
        cd ofb-mock-server && bash generate-certs.sh && cd .. || echo "âš ï¸  Certificate generation failed, will try without certs"

        echo "ğŸ”¨ Building main API JAR..."
        if {{.MVNW}} clean package -Dmaven.test.skip=true; then
          echo "ğŸ”¨ Building OFB mock server JAR..."
          if cd ofb-mock-server && {{.MVNW}} clean package -Dmaven.test.skip=true -Dorg.slf4j.simpleLogger.defaultLogLevel=error -Dorg.slf4j.simpleLogger.log.org.openapitools=off && cd ..; then
            echo "ğŸ³ Rebuilding Docker images (fast local build)..."
            if docker build -t dynamic-portfolio-api-api:latest -f Dockerfile.local . && docker build -t dynamic-portfolio-api-ofb-mock-server:latest -f ofb-mock-server/Dockerfile.local ofb-mock-server; then
              BUILD_SUCCESS=true
            fi
          fi
        fi

        if [ "$BUILD_SUCCESS" = false ]; then
          echo "âš ï¸  Local build failed - falling back to Docker multi-stage build"
          echo "ğŸ³ Building application (compiles inside Docker)..."
          docker compose build --pull || (echo "âŒ Docker build also failed!" && exit 1)
        fi
      - echo "ğŸš€ Starting all services..."
      - docker compose up -d --wait
      - echo "âœ… All services rebuilt and started successfully!"

  dev:
    desc: Run application locally (requires database running)
    cmds:
      - task: ensure-db-running
      - |
        if command -v mvn >/dev/null 2>&1; then
          mvn spring-boot:run
        else
          echo "âŒ Maven not found. Install via SDKMAN or manually."
          exit 1
        fi

  ensure-db-running:
    desc: Ensure database is running
    internal: true
    env:
      SERVER_PORT: '{{.SERVER_PORT}}'
    cmds:
      - |
        echo "ğŸš€ Starting database services..."
        docker compose up sqlserver sqlserver-init flyway -d
        echo "â³ Database starting (this may take a minute)..."

  db-console:
    desc: Connect to SQL Server console
    cmds:
      - |
        docker compose exec sqlserver /opt/mssql-tools18/bin/sqlcmd \
          -S localhost -U sa -P YourStrong@Passw0rd -C

  health:
    desc: Check API health endpoint
    cmds:
      - curl -s http://localhost:{{.SERVER_PORT}}/api/v1/actuator/health | jq . || curl http://localhost:{{.SERVER_PORT}}/api/v1/actuator/health

  token:
    desc: Get OAuth2 token for testing (saves to /tmp/token.txt)
    cmds:
      - |
        echo "ğŸ”‘ Getting OAuth2 token for ADMIN user..."
        TOKEN=$(curl -s -X POST "http://localhost:{{.SERVER_PORT}}/api/v1/oauth2/token" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -u "portfolio-web-app:webapp-secret" \
          -d "grant_type=password&username=admin@demo.local&password=admin123&scope=read write openid profile" \
          | jq -r '.access_token')
        echo "$TOKEN" > /tmp/token.txt
        echo "âœ… Token saved to /tmp/token.txt"
        echo "Token: $TOKEN"

  token-customer:
    desc: Get OAuth2 token for customer user (saves to /tmp/token.txt)
    cmds:
      - |
        echo "ğŸ”‘ Getting OAuth2 token for CUSTOMER user..."
        TOKEN=$(curl -s -X POST "http://localhost:{{.SERVER_PORT}}/api/v1/oauth2/token" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -u "portfolio-web-app:webapp-secret" \
          -d "grant_type=password&username=joao.silva@example.com&password=customer123&scope=read write openid profile" \
          | jq -r '.access_token')
        echo "$TOKEN" > /tmp/token.txt
        echo "âœ… Token saved to /tmp/token.txt"
        echo "Token: $TOKEN"

  test-endpoints:
    desc: Test main API endpoints with saved token
    cmds:
      - |
        if [ ! -f /tmp/token.txt ]; then
          echo "âŒ No token found. Run 'task token' first."
          exit 1
        fi
        TOKEN=$(cat /tmp/token.txt)
        echo "ğŸ§ª Testing /perfil-risco/1..."
        curl -s -H "Authorization: Bearer $TOKEN" "http://localhost:{{.SERVER_PORT}}/api/v1/perfil-risco/1" | jq .
        echo ""
        echo "ğŸ§ª Testing /investimentos/1..."
        curl -s -H "Authorization: Bearer $TOKEN" "http://localhost:{{.SERVER_PORT}}/api/v1/investimentos/1" | jq .

  test-simulation:
    desc: Test simulation endpoint with saved token
    cmds:
      - |
        if [ ! -f /tmp/token.txt ]; then
          echo "âŒ No token found. Run 'task token' first."
          exit 1
        fi
        TOKEN=$(cat /tmp/token.txt)
        echo "ğŸ§ª Testing /simular-investimento..."
        curl -s -X POST -H "Authorization: Bearer $TOKEN" \
          -H "Content-Type: application/json" \
          "http://localhost:{{.SERVER_PORT}}/api/v1/simular-investimento" \
          -d '{"clienteId":1,"tipoInvestimento":"CDB","valor":10000,"prazo":12}' | jq .

  clean-build:
    desc: Clean Maven build artifacts
    cmds:
      - |
        if command -v mvn >/dev/null 2>&1; then
          mvn clean
        else
          echo "Removing target directory..."
          rm -rf target/
        fi

  newman:docker-up:
    desc: Start all Docker containers for Newman tests
    env:
      SERVER_PORT: '{{.SERVER_PORT}}'
    cmds:
      - echo "ğŸš€ Starting Docker containers..."
      - docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d --wait --force-recreate || true
      - echo "âœ… All services are running"

  newman:local:
    desc: Run Newman API tests against local Docker with fresh data
    deps:
      - check-newman
    cmds:
      - echo "ğŸ§ª Setting up test environment..."
      - task: ensure-newman-env-ready
      - echo "ğŸ“Š Running Newman tests against local Docker..."
      - |
        newman run postman/Dynamic-Portfolio-API.postman_collection.json \
          -e postman/environments/local-docker.postman_environment.json \
          --reporters cli,htmlextra \
          --reporter-htmlextra-export reports/newman-local-report.html \
          --color on || (echo "âŒ Newman tests failed! Check reports/newman-local-report.html" && exit 1)
        echo "âœ… All Newman tests passed! Report: reports/newman-local-report.html"

  newman:test:
    desc: Run Newman API tests against test environment (port 8081)
    deps:
      - check-newman
    cmds:
      - echo "ğŸ§ª Running Newman tests against test environment..."
      - |
        newman run postman/Dynamic-Portfolio-API.postman_collection.json \
          -e postman/environments/test.postman_environment.json \
          --reporters cli,htmlextra \
          --reporter-htmlextra-export reports/newman-test-report.html \
          --color on || (echo "âŒ Newman tests failed! Check reports/newman-test-report.html" && exit 1)
        echo "âœ… All Newman tests passed! Report: reports/newman-test-report.html"

  newman:ci:
    desc: Run Newman tests in CI/CD mode (fail fast, minimal output)
    deps:
      - check-newman
    cmds:
      - echo "ğŸ¤– Running Newman tests in CI/CD mode..."
      - |
        newman run postman/Dynamic-Portfolio-API.postman_collection.json \
          -e postman/environments/ci.postman_environment.json \
          --bail \
          --reporters cli,json \
          --reporter-json-export reports/newman-ci-results.json \
          --color off || (echo "âŒ Newman tests failed!" && exit 1)
        echo "âœ… CI tests passed!"

  newman:fresh:
    desc: Run Newman tests with completely fresh database (teardown + setup + test)
    deps:
      - check-newman
    cmds:
      - echo "ğŸ§¹ Cleaning up existing containers and data..."
      - task: docker-clean
      - echo "ğŸš€ Starting fresh Docker environment..."
      - task: docker-up
      - echo "â³ Waiting for services to be ready..."
      - sleep 10
      - echo "ğŸ“Š Seeding test data..."
      - task: seed-test-data
      - echo "ğŸ§ª Running Newman tests..."
      - task: newman:local
      - echo "âœ… Fresh environment tests completed!"

  newman:report:
    desc: Generate comprehensive Newman HTML report
    deps:
      - check-newman
    cmds:
      - mkdir -p reports
      - |
        newman run postman/Dynamic-Portfolio-API.postman_collection.json \
          -e postman/environments/local-docker.postman_environment.json \
          --reporters htmlextra \
          --reporter-htmlextra-export reports/newman-detailed-report.html \
          --reporter-htmlextra-showOnlyFails \
          --reporter-htmlextra-darkTheme \
          --reporter-htmlextra-title "Dynamic Portfolio API - Contract Tests" \
          --color on
        echo "ğŸ“Š Detailed report generated: reports/newman-detailed-report.html"
        if command -v open >/dev/null 2>&1; then
          open reports/newman-detailed-report.html
        elif command -v xdg-open >/dev/null 2>&1; then
          xdg-open reports/newman-detailed-report.html
        else
          echo "ğŸ’¡ Open reports/newman-detailed-report.html in your browser"
        fi

  seed-test-data:
    desc: Seed database with test data for Newman tests
    cmds:
      - |
        echo "ğŸ“Š Loading test data into database..."
        docker compose exec -T sqlserver /opt/mssql-tools18/bin/sqlcmd \
          -S localhost -U sa -P YourStrong@Passw0rd -C \
          -i /scripts/setup-test-data.sql \
          || echo "âš ï¸  Test data seeding may have failed - check if database is ready"

  ensure-newman-env-ready:
    desc: Ensure Docker environment is ready for Newman tests
    internal: true
    cmds:
      - |
        if ! docker compose ps | grep -q "api.*running"; then
          echo "âš ï¸  API container not running, starting services..."
          task newman:docker-up
          echo "â³ Waiting for API to be ready..."
          sleep 10
        fi
      - task: seed-test-data

  check-newman:
    desc: Check if Newman is installed
    internal: true
    cmds:
      - |
        if ! command -v newman >/dev/null 2>&1; then
          echo "âŒ Newman is not installed"
          echo "ğŸ“¥ Install via: npm install -g newman newman-reporter-htmlextra"
          exit 1
        fi
        echo "âœ… Newman found: $(newman --version)"

  quick:
    desc: Quick rebuild and test (stops containers, rebuilds, starts, gets token, tests endpoints)
    cmds:
      - task: rebuild-all
      - task: token
      - task: test-endpoints

  help:
    desc: Show detailed help information
    cmds:
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo "  {{.PROJECT_NAME}} - Task Runner Commands"
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ğŸš€ Quick Start:"
      - echo "   task setup             - Complete project setup"
      - echo "   task quick             - Rebuild + test everything"
      - echo "   task docker-up         - Start all services"
      - echo "   task docker-down       - Stop all services"
      - echo ""
      - echo "ğŸ”¨ Building:"
      - echo "   task rebuild-all       - Rebuild both APIs + Docker"
      - echo "   task rebuild-api       - Rebuild main API only"
      - echo "   task build-local       - Build JAR locally"
      - echo ""
      - echo "ğŸ§ª Testing:"
      - echo "   task token             - Get OAuth2 token (admin)"
      - echo "   task token-customer    - Get OAuth2 token (customer)"
      - echo "   task test-endpoints    - Test main endpoints"
      - echo "   task test-simulation   - Test simulation endpoint"
      - echo "   task test              - Run unit tests"
      - echo ""
      - echo "ğŸ§ª API Testing (Newman):"
      - echo "   task newman:local      - Run API tests (local Docker)"
      - echo "   task newman:fresh      - Run with fresh database"
      - echo "   task newman:test       - Run against test env"
      - echo "   task newman:ci         - Run in CI/CD mode"
      - echo "   task newman:report     - Generate detailed report"
      - echo ""
      - echo "ğŸ” Monitoring:"
      - echo "   task status            - Container status"
      - echo "   task logs              - All logs"
      - echo "   task logs-api          - API logs only"
      - echo "   task health            - API health check"
      - echo ""
      - echo "ğŸ§¹ Cleanup:"
      - echo "   task docker-clean      - Remove all containers & volumes"
      - echo ""
      - echo "âš™ï¸  Configuration:"
      - echo "   SERVER_PORT={{.SERVER_PORT}} (override with SERVER_PORT=8081 task ...)"
      - echo ""
      - echo "ğŸ’¡ Run 'task --list' to see all available tasks"
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
