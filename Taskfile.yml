version: '3'

vars:
  PROJECT_NAME: dynamic-portfolio-api
  DOCKER_MIN_VERSION: "20.10"
  DOCKER_COMPOSE_MIN_VERSION: "2.0"

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  run:
    desc: Run the entire application (installs Task if needed, then runs setup)
    deps:
      - setup

  setup:
    desc: Complete project setup (checks dependencies, installs tools, starts services)
    silent: true
    cmds:
      - task: check-dependencies
      - task: install-tools
      - task: docker-up
      - |
        PORT=${SERVER_PORT:-8080}
        echo "âœ… Setup complete! API is available at http://localhost:$PORT/api/v1"
        echo "ğŸ“– Access API docs at http://localhost:$PORT/api/v1/swagger-ui.html"

  check-dependencies:
    desc: Check if required dependencies are installed
    silent: true
    cmds:
      - task: check-docker
      - task: check-docker-compose
      - echo "âœ… All dependencies satisfied"

  check-docker:
    desc: Verify Docker is installed and version is sufficient
    silent: true
    cmds:
      - |
        if ! command -v docker >/dev/null 2>&1; then
          echo "âŒ Docker is not installed"
          echo "ğŸ“¥ Install from: https://docs.docker.com/get-docker/"
          exit 1
        fi
        echo "âœ… Docker found: $(docker --version)"

  check-docker-compose:
    desc: Verify Docker Compose is installed
    silent: true
    cmds:
      - |
        if ! docker compose version >/dev/null 2>&1; then
          echo "âŒ Docker Compose is not available"
          echo "ğŸ“¥ Install Docker Desktop or Docker Compose plugin"
          exit 1
        fi
        echo "âœ… Docker Compose found: $(docker compose version)"

  install-tools:
    desc: Install optional development tools (Java, Maven) via SDKMAN
    silent: true
    cmds:
      - |
        # Source SDKMAN if it exists (use bash for compatibility)
        if [ -f "$HOME/.sdkman/bin/sdkman-init.sh" ]; then
          bash -c 'source "$HOME/.sdkman/bin/sdkman-init.sh" && sdk env install' || echo "âš ï¸  Tools may already be installed"
        elif command -v sdk >/dev/null 2>&1; then
          echo "ğŸ“¦ SDKMAN detected, installing Java and Maven..."
          sdk env install || echo "âš ï¸  Tools may already be installed"
        else
          echo "âš ï¸  SDKMAN not found - skipping local development tools"
          echo "ğŸ’¡ For local development, install SDKMAN: https://sdkman.io/"
          echo "ğŸ’¡ Or ensure Java 21 and Maven 3.9+ are installed manually"
        fi

  docker-up:
    desc: Start all Docker containers
    silent: true
    cmds:
      - echo "ğŸš€ Building application..."
      - docker compose build --pull || (echo "âŒ Build failed! Check Docker is running." && exit 1)
      - echo "ğŸš€ Starting Docker containers..."
      - docker compose up -d --wait --force-recreate || (echo "âŒ Container startup failed! Showing logs:" && docker compose logs --tail=50 && exit 1)
      - echo "âœ… All services are running"

  docker-down:
    desc: Stop all Docker containers
    cmds:
      - echo "ğŸ›‘ Stopping Docker containers..."
      - docker compose down

  docker-clean:
    desc: Stop containers and remove volumes (clean slate)
    cmds:
      - echo "ğŸ§¹ Cleaning up containers and volumes..."
      - docker compose down -v
      - echo "âœ… Clean up complete"

  logs:
    desc: Show logs from all containers
    cmds:
      - docker compose logs -f

  logs-api:
    desc: Show API container logs
    cmds:
      - docker compose logs -f api

  logs-db:
    desc: Show database container logs
    cmds:
      - docker compose logs -f sqlserver

  logs-flyway:
    desc: Show Flyway migration logs
    cmds:
      - docker compose logs flyway

  status:
    desc: Show status of all containers
    cmds:
      - docker compose ps

  test:
    desc: Run all tests (requires Java and Maven)
    cmds:
      - |
        if command -v mvn >/dev/null 2>&1; then
          mvn test
        else
          echo "âŒ Maven not found. Install via SDKMAN or manually."
          exit 1
        fi

  build:
    desc: Build the application (requires Java and Maven)
    cmds:
      - |
        if command -v mvn >/dev/null 2>&1; then
          mvn clean package
        else
          echo "âŒ Maven not found. Install via SDKMAN or manually."
          exit 1
        fi

  dev:
    desc: Run application locally (requires database running)
    cmds:
      - task: ensure-db-running
      - |
        if command -v mvn >/dev/null 2>&1; then
          mvn spring-boot:run
        else
          echo "âŒ Maven not found. Install via SDKMAN or manually."
          exit 1
        fi

  ensure-db-running:
    desc: Ensure database is running
    internal: true
    cmds:
      - |
        echo "ğŸš€ Starting database services..."
        docker compose up sqlserver sqlserver-init flyway -d
        echo "â³ Database starting (this may take a minute)..."

  db-console:
    desc: Connect to SQL Server console
    cmds:
      - |
        docker compose exec sqlserver /opt/mssql-tools18/bin/sqlcmd \
          -S localhost -U sa -P YourStrong@Passw0rd -C

  health:
    desc: Check API health endpoint
    cmds:
      - curl -s http://localhost:8080/api/v1/actuator/health | jq . || curl http://localhost:8080/api/v1/actuator/health

  clean-build:
    desc: Clean Maven build artifacts
    cmds:
      - |
        if command -v mvn >/dev/null 2>&1; then
          mvn clean
        else
          echo "Removing target directory..."
          rm -rf target/
        fi

  newman:docker-up:
    desc: Start all Docker containers for Newman tests
    silent: true
    cmds:
      - echo "ğŸš€ Starting Docker containers..."
      - docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d --wait --force-recreate || true
      - echo "âœ… All services are running"

  newman:local:
    desc: Run Newman API tests against local Docker with fresh data
    deps:
      - check-newman
    cmds:
      - echo "ğŸ§ª Setting up test environment..."
      - task: ensure-newman-env-ready
      - echo "ğŸ“Š Running Newman tests against local Docker..."
      - |
        newman run postman/Dynamic-Portfolio-API.postman_collection.json \
          -e postman/environments/local-docker.postman_environment.json \
          --reporters cli,htmlextra \
          --reporter-htmlextra-export reports/newman-local-report.html \
          --color on || (echo "âŒ Newman tests failed! Check reports/newman-local-report.html" && exit 1)
        echo "âœ… All Newman tests passed! Report: reports/newman-local-report.html"

  newman:test:
    desc: Run Newman API tests against test environment (port 8081)
    deps:
      - check-newman
    cmds:
      - echo "ğŸ§ª Running Newman tests against test environment..."
      - |
        newman run postman/Dynamic-Portfolio-API.postman_collection.json \
          -e postman/environments/test.postman_environment.json \
          --reporters cli,htmlextra \
          --reporter-htmlextra-export reports/newman-test-report.html \
          --color on || (echo "âŒ Newman tests failed! Check reports/newman-test-report.html" && exit 1)
        echo "âœ… All Newman tests passed! Report: reports/newman-test-report.html"

  newman:ci:
    desc: Run Newman tests in CI/CD mode (fail fast, minimal output)
    deps:
      - check-newman
    cmds:
      - echo "ğŸ¤– Running Newman tests in CI/CD mode..."
      - |
        newman run postman/Dynamic-Portfolio-API.postman_collection.json \
          -e postman/environments/ci.postman_environment.json \
          --bail \
          --reporters cli,json \
          --reporter-json-export reports/newman-ci-results.json \
          --color off || (echo "âŒ Newman tests failed!" && exit 1)
        echo "âœ… CI tests passed!"

  newman:fresh:
    desc: Run Newman tests with completely fresh database (teardown + setup + test)
    deps:
      - check-newman
    cmds:
      - echo "ğŸ§¹ Cleaning up existing containers and data..."
      - task: docker-clean
      - echo "ğŸš€ Starting fresh Docker environment..."
      - task: docker-up
      - echo "â³ Waiting for services to be ready..."
      - sleep 10
      - echo "ğŸ“Š Seeding test data..."
      - task: seed-test-data
      - echo "ğŸ§ª Running Newman tests..."
      - task: newman:local
      - echo "âœ… Fresh environment tests completed!"

  newman:report:
    desc: Generate comprehensive Newman HTML report
    deps:
      - check-newman
    cmds:
      - mkdir -p reports
      - |
        newman run postman/Dynamic-Portfolio-API.postman_collection.json \
          -e postman/environments/local-docker.postman_environment.json \
          --reporters htmlextra \
          --reporter-htmlextra-export reports/newman-detailed-report.html \
          --reporter-htmlextra-showOnlyFails \
          --reporter-htmlextra-darkTheme \
          --reporter-htmlextra-title "Dynamic Portfolio API - Contract Tests" \
          --color on
        echo "ğŸ“Š Detailed report generated: reports/newman-detailed-report.html"
        if command -v open >/dev/null 2>&1; then
          open reports/newman-detailed-report.html
        elif command -v xdg-open >/dev/null 2>&1; then
          xdg-open reports/newman-detailed-report.html
        else
          echo "ğŸ’¡ Open reports/newman-detailed-report.html in your browser"
        fi

  seed-test-data:
    desc: Seed database with test data for Newman tests
    silent: true
    cmds:
      - |
        echo "ğŸ“Š Loading test data into database..."
        docker compose exec -T sqlserver /opt/mssql-tools18/bin/sqlcmd \
          -S localhost -U sa -P YourStrong@Passw0rd -C \
          -i /scripts/setup-test-data.sql \
          || echo "âš ï¸  Test data seeding may have failed - check if database is ready"

  ensure-newman-env-ready:
    desc: Ensure Docker environment is ready for Newman tests
    internal: true
    cmds:
      - |
        if ! docker compose ps | grep -q "api.*running"; then
          echo "âš ï¸  API container not running, starting services..."
          task newman:docker-up
          echo "â³ Waiting for API to be ready..."
          sleep 10
        fi
      - task: seed-test-data

  check-newman:
    desc: Check if Newman is installed
    internal: true
    silent: true
    cmds:
      - |
        if ! command -v newman >/dev/null 2>&1; then
          echo "âŒ Newman is not installed"
          echo "ğŸ“¥ Install via: npm install -g newman newman-reporter-htmlextra"
          exit 1
        fi
        echo "âœ… Newman found: $(newman --version)"

  help:
    desc: Show detailed help information
    cmds:
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo "  {{.PROJECT_NAME}} - Task Runner Commands"
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ğŸš€ Quick Start:"
      - echo "   task setup          - Complete project setup"
      - echo "   task docker-up      - Start all services"
      - echo "   task docker-down    - Stop all services"
      - echo ""
      - echo "ğŸ“‹ Development:"
      - echo "   task dev            - Run locally (needs DB)"
      - echo "   task test           - Run unit tests"
      - echo "   task build          - Build JAR"
      - echo ""
      - echo "ğŸ§ª API Testing (Newman):"
      - echo "   task newman:local   - Run API tests (local Docker)"
      - echo "   task newman:fresh   - Run with fresh database"
      - echo "   task newman:test    - Run against test env"
      - echo "   task newman:ci      - Run in CI/CD mode"
      - echo "   task newman:report  - Generate detailed report"
      - echo ""
      - echo "ğŸ” Monitoring:"
      - echo "   task status         - Container status"
      - echo "   task logs           - All logs"
      - echo "   task health         - API health check"
      - echo ""
      - echo "ğŸ§¹ Cleanup:"
      - echo "   task docker-clean   - Remove all containers & volumes"
      - echo ""
      - echo "ğŸ’¡ Run 'task --list' to see all available tasks"
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
