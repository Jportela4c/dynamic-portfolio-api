version: '3'

vars:
  PROJECT_NAME: dynamic-portfolio-api
  DOCKER_MIN_VERSION: "20.10"
  DOCKER_COMPOSE_MIN_VERSION: "2.0"

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  run:
    desc: Run the entire application (installs Task if needed, then runs setup)
    deps:
      - setup

  setup:
    desc: Complete project setup (checks dependencies, installs tools, starts services)
    silent: true
    cmds:
      - task: check-dependencies
      - task: install-tools
      - task: docker-up
      - |
        PORT=${SERVER_PORT:-8080}
        echo "âœ… Setup complete! API is available at http://localhost:$PORT"
        echo "ğŸ“– Access API docs at http://localhost:$PORT/swagger-ui.html"

  check-dependencies:
    desc: Check if required dependencies are installed
    silent: true
    cmds:
      - task: check-docker
      - task: check-docker-compose
      - echo "âœ… All dependencies satisfied"

  check-docker:
    desc: Verify Docker is installed and version is sufficient
    silent: true
    cmds:
      - |
        if ! command -v docker >/dev/null 2>&1; then
          echo "âŒ Docker is not installed"
          echo "ğŸ“¥ Install from: https://docs.docker.com/get-docker/"
          exit 1
        fi
        echo "âœ… Docker found: $(docker --version)"

  check-docker-compose:
    desc: Verify Docker Compose is installed
    silent: true
    cmds:
      - |
        if ! docker compose version >/dev/null 2>&1; then
          echo "âŒ Docker Compose is not available"
          echo "ğŸ“¥ Install Docker Desktop or Docker Compose plugin"
          exit 1
        fi
        echo "âœ… Docker Compose found: $(docker compose version)"

  install-tools:
    desc: Install optional development tools (Java, Maven) via SDKMAN
    silent: true
    cmds:
      - |
        if command -v sdk >/dev/null 2>&1; then
          echo "ğŸ“¦ SDKMAN detected, installing Java and Maven..."
          sdk env install || echo "âš ï¸  Tools may already be installed"
        else
          echo "âš ï¸  SDKMAN not found - skipping local development tools"
          echo "ğŸ’¡ For local development, install SDKMAN: https://sdkman.io/"
          echo "ğŸ’¡ Or ensure Java 21 and Maven 3.9+ are installed manually"
        fi

  docker-up:
    desc: Start all Docker containers
    silent: true
    cmds:
      - echo "ğŸš€ Starting Docker containers..."
      - docker compose up -d
      - echo "â³ Waiting for services to be healthy..."
      - task: wait-healthy
      - echo "âœ… All services are running"

  docker-down:
    desc: Stop all Docker containers
    cmds:
      - echo "ğŸ›‘ Stopping Docker containers..."
      - docker compose down

  docker-clean:
    desc: Stop containers and remove volumes (clean slate)
    cmds:
      - echo "ğŸ§¹ Cleaning up containers and volumes..."
      - docker compose down -v
      - echo "âœ… Clean up complete"

  wait-healthy:
    desc: Wait for Docker containers to be healthy
    silent: true
    cmds:
      - |
        echo "Waiting for containers to be healthy (this may take up to 60 seconds)..."
        docker compose wait api 2>/dev/null || echo "âœ… Services starting (check with: task status)"

  logs:
    desc: Show logs from all containers
    cmds:
      - docker compose logs -f

  logs-api:
    desc: Show API container logs
    cmds:
      - docker compose logs -f api

  logs-db:
    desc: Show database container logs
    cmds:
      - docker compose logs -f sqlserver

  logs-flyway:
    desc: Show Flyway migration logs
    cmds:
      - docker compose logs flyway

  status:
    desc: Show status of all containers
    cmds:
      - docker compose ps

  test:
    desc: Run all tests (requires Java and Maven)
    cmds:
      - |
        if command -v mvn >/dev/null 2>&1; then
          mvn test
        else
          echo "âŒ Maven not found. Install via SDKMAN or manually."
          exit 1
        fi

  build:
    desc: Build the application (requires Java and Maven)
    cmds:
      - |
        if command -v mvn >/dev/null 2>&1; then
          mvn clean package
        else
          echo "âŒ Maven not found. Install via SDKMAN or manually."
          exit 1
        fi

  dev:
    desc: Run application locally (requires database running)
    cmds:
      - task: ensure-db-running
      - |
        if command -v mvn >/dev/null 2>&1; then
          mvn spring-boot:run
        else
          echo "âŒ Maven not found. Install via SDKMAN or manually."
          exit 1
        fi

  ensure-db-running:
    desc: Ensure database is running
    internal: true
    cmds:
      - |
        echo "ğŸš€ Starting database services..."
        docker compose up sqlserver sqlserver-init flyway -d
        docker compose wait sqlserver 2>/dev/null || echo "â³ Database starting..."

  db-console:
    desc: Connect to SQL Server console
    cmds:
      - |
        docker compose exec sqlserver /opt/mssql-tools18/bin/sqlcmd \
          -S localhost -U sa -P YourStrong@Passw0rd -C

  health:
    desc: Check API health endpoint
    cmds:
      - curl -s http://localhost:8080/actuator/health | jq . || curl http://localhost:8080/actuator/health

  clean-build:
    desc: Clean Maven build artifacts
    cmds:
      - |
        if command -v mvn >/dev/null 2>&1; then
          mvn clean
        else
          echo "Removing target directory..."
          rm -rf target/
        fi

  help:
    desc: Show detailed help information
    cmds:
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo "  {{.PROJECT_NAME}} - Task Runner Commands"
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ğŸš€ Quick Start:"
      - echo "   task setup          - Complete project setup"
      - echo "   task docker-up      - Start all services"
      - echo "   task docker-down    - Stop all services"
      - echo ""
      - echo "ğŸ“‹ Development:"
      - echo "   task dev            - Run locally (needs DB)"
      - echo "   task test           - Run tests"
      - echo "   task build          - Build JAR"
      - echo ""
      - echo "ğŸ” Monitoring:"
      - echo "   task status         - Container status"
      - echo "   task logs           - All logs"
      - echo "   task health         - API health check"
      - echo ""
      - echo "ğŸ§¹ Cleanup:"
      - echo "   task docker-clean   - Remove all containers & volumes"
      - echo ""
      - echo "ğŸ’¡ Run 'task --list' to see all available tasks"
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
